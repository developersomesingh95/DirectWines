name: Build and Deploy iOS App

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      # Checkout the code
      - name: Checkout code
        uses: actions/checkout@v2
      
      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      # Install dependencies
      - name: Install dependencies
        run: |
          npm install --legacy-peer-deps
          npm install -g react-native-cli

      # Install CocoaPods
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update

      # Set up Xcode command line tools
      - name: Set up Xcode
        run: |
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          sudo xcodebuild -runFirstLaunch

      # Set environment variables for Fastlane
      - name: Set up environment variables
        run: |
          echo "MATCH_PASSWORD=${{ secrets.MATCH_PASSWORD }}" >> $GITHUB_ENV
          echo "DEVELOPER_APP_ID=${{ secrets.DEVELOPER_APP_ID }}" >> $GITHUB_ENV
          echo "DEVELOPER_APP_IDENTIFIER=${{ secrets.DEVELOPER_APP_IDENTIFIER }}" >> $GITHUB_ENV

      # Run Fastlane
      - name: Run Fastlane
        run: fastlane ios deploy_to_app_store
        working-directory: ios
        env:
          APP_STORE_CONNECT_TEAM_ID: '${{ secrets.APP_STORE_CONNECT_TEAM_ID }}'
          DEVELOPER_APP_ID: '${{ secrets.DEVELOPER_APP_ID }}'
          MATCH_PASSWORD: '${{ secrets.MATCH_PASSWORD }}'
